@page "/"
@using KafkaTester.Model
@using KafkaTester.Components

<h2><img class="logo" src="image/logo-mini.png" alt="logo" /> K-Tester</h2>
<hr />
<div>
    <form>
        <div class="row">
            <div class="col-10">
                <Settings Options="@_options" OnChanged="@Refresh" />
            </div>
        </div>
    </form>
    <form>
        <div class="row">
            <div class="col-5">
                <div class="form-group row">
                    <label for="brokers" class="col-2 col-form-label text-right">Brokers</label>
                    <div class="col-10">
                        <div class="input-group">
                            <input type="text" class="form-control" id="brokers" placeholder="host" @bind="_options.KafkaConfig.CurrentSetting.Brokers">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" data-toggle="modal" data-target="#brokerOptionsModal"><span class="oi oi-wrench"></span></button>
                                <button class="btn btn-outline-secondary @(_options.KafkaConfig.CurrentSetting.IsSaslActivated ? " btn-primary" : string.Empty)" type="button" data-toggle="modal" data-target="#brokerSecurityModal"><span class="oi oi-lock-unlocked"></span></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-5">
                <Topic Options="@_options" />
            </div>
        </div>
        <div class="row">
            <div class="col-5">
                <Filter Options="@_options" OnChanged="Refresh" />
            </div>
            <div class="col-5 text-right">
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" @onclick="OnSearch" disabled="@(string.IsNullOrWhiteSpace(_options.KafkaConfig.CurrentSetting.Brokers) && string.IsNullOrWhiteSpace(_options.KafkaConfig.CurrentSetting.Topic))">@(_isSearch ? "Stop" : "Search")</button>
                    <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="sr-only">Toggle Dropdown</span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-right">
                        <button type="button" class="dropdown-item text-success" data-toggle="modal" data-target="#saveSettingModal" disabled="@(string.IsNullOrWhiteSpace(_options.KafkaConfig.CurrentSetting.Brokers) || string.IsNullOrWhiteSpace(_options.KafkaConfig.CurrentSetting.Topic))"><span class="oi oi-file"></span> Save</button>
                        <button type="button" class="dropdown-item text-danger" data-toggle="modal" data-target="#deleteSettingModal" disabled="@string.IsNullOrWhiteSpace(_options.KafkaConfig.CurrentSetting.Name)"><span class="oi oi-trash"></span> Delete</button>
                        <div class="dropdown-divider"></div>
                        <button type="button" class="dropdown-item" data-toggle="modal" data-target="#sendMessageModal" disabled="@(string.IsNullOrWhiteSpace(_options.KafkaConfig.CurrentSetting.Brokers) && string.IsNullOrWhiteSpace(_options.KafkaConfig.CurrentSetting.Topic))">Send message</button>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#" data-toggle="modal" data-target="#exportConfigurationModal" @onclick="ExportConfiguration">Export configuration</a>
                        <a class="dropdown-item" href="#" data-toggle="modal" data-target="#importConfigurationModal">Import configuration</a>
                        <div class="dropdown-divider"></div>
                        <button type="button" class="dropdown-item" data-toggle="modal" data-target="#shareConfigurationModal" @onclick="OnShare" disabled="@(string.IsNullOrWhiteSpace(_options.KafkaConfig.CurrentSetting.Brokers) || string.IsNullOrWhiteSpace(_options.KafkaConfig.CurrentSetting.Topic))"><span class="oi oi-share"></span> Share</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
<Messages SelectedMessage="@_selectedMessage" IsSearching="@_isSearch" Items="@_filterMessages" Errors="@_errors" Options="@_options" CountTotalMessages="@_messages.Count" />

<div class="modal fade" id="sendMessageModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Message</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div>
                    <div>
                        <div class="form-group row"><div class="col">Headers <button type="button" class="btn btn-info btn-sm" @onclick="CreateHeader"><i class="oi oi-plus"></i></button></div></div>

                        @if (_newMessage.Headers.Any())
                        {
                            @foreach (var header in _newMessage.Headers)
                            {
                                <div class="row">
                                    <div class="col"><input type="text" class="form-control" placeholder="Key" @bind="@header.Key" /></div>
                                    <div class="col">
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" placeholder="Value" @bind="@header.Value">
                                            <div class="input-group-append">
                                                <button type="button" class="btn btn-outline-danger" @onclick="@(() => RemoveHeader(header))"><i class="oi oi-trash"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                            <div class="alert alert-info">Value will always be a string (ex: 42 will result as "42")</div>
                        }
                    </div>
                </div>
                <hr />
                <textarea class="form-control" id="message" rows="5" placeholder="{ ... }" @bind="_newMessage.Message" @bind:event="oninput" @onkeyup="OnNewMessageChange"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" @onclick="SendMessage" disabled="@string.IsNullOrWhiteSpace(_newMessage.Message)">Send</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="importConfigurationModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="importConfigurationString" rows="5" @bind="_importConfigurationString"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" @onclick="ImportConfiguration" disabled="@string.IsNullOrWhiteSpace(_importConfigurationString)">Import</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="exportConfigurationModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export configuration</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="exportConfigurationString" readonly rows="5" @bind="_exportConfigurationString"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="shareConfigurationModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share configuration</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="shareConfigurationString" readonly rows="2" @bind="_shareConfigurationString"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="brokerSecurityModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Security</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isSaslActivated" @bind="_options.KafkaConfig.CurrentSetting.IsSaslActivated">
                            <label class="form-check-label" for="isSaslActivated">Activate SASL</label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-6">
                            <label for="securityProtocol">Security protocol</label>
                            <select class="form-control" id="securityProtocol" @bind="_options.KafkaConfig.CurrentSetting.SecurityProtocol" disabled="@(!_options.KafkaConfig.CurrentSetting.IsSaslActivated)">
                                @foreach (var protocol in Enum.GetValues<Confluent.Kafka.SecurityProtocol>())
                                {
                                    <option value="@protocol">@protocol</option>
                                }
                            </select>
                        </div>
                        <div class="form-group col-6">
                            <label for="saslMechanism">SASL mechanism</label>
                            <select class="form-control" id="saslMechanism" @bind="_options.KafkaConfig.CurrentSetting.SaslMechanism" disabled="@(!_options.KafkaConfig.CurrentSetting.IsSaslActivated)">
                                @foreach (var mechanism in Enum.GetValues<Confluent.Kafka.SaslMechanism>())
                                {
                                    <option value="@mechanism">@mechanism</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="saslUserName">Username</label>
                        <input type="text" class="form-control" id="saslUserName" placeholder="username" @bind="_options.KafkaConfig.CurrentSetting.SaslUsername" disabled="@(!_options.KafkaConfig.CurrentSetting.IsSaslActivated)">
                    </div>
                    <div class="form-group">
                        <label for="saslPassword">Password</label>
                        <input type="password" class="form-control" id="saslPassword" placeholder="password" @bind="_options.KafkaConfig.CurrentSetting.SaslPassword" disabled="@(!_options.KafkaConfig.CurrentSetting.IsSaslActivated)">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="brokerOptionsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Options</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isGzipActivated" @bind="_options.KafkaConfig.CurrentSetting.IsGzipActivated">
                            <label class="form-check-label" for="isGzipActivated">Try activate GZIP decompression (can take more time to process)</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
